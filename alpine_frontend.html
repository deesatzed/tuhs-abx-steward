<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TUHS Antibiotic Steward</title>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.19/dist/full.min.css" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked@12.0.1/marked.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <style>
    .clinical-response { line-height: 1.6; font-size: 0.95rem; }
    .clinical-response h2, .clinical-response h3, .clinical-response h4 {
      color: #1f2937; margin-top: 1.5rem; margin-bottom: 0.75rem; font-weight: 600;
    }
    .clinical-response h2 {
      border-left: 4px solid #3b82f6; padding-left: 0.75rem; font-size: 1.25rem;
    }
    .clinical-response h3 { color: #059669; font-size: 1.1rem; }
    .clinical-response p { margin-bottom: 0.75rem; }
    .clinical-response ul, .clinical-response ol {
      margin-bottom: 1rem; padding-left: 1.5rem;
    }
    .clinical-response li { margin-bottom: 0.25rem; }
    .clinical-response strong { color: #1f2937; font-weight: 600; }
  </style>
</head>
<body class="bg-base-300" x-data="abxForm()">
  <div class="container mx-auto p-4">
    <!-- Header -->
    <header class="navbar bg-base-100 shadow-xl rounded-box mb-4">
      <div class="flex-1">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-primary mr-2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M11.42 15.17 17.25 21A2.652 2.652 0 0 0 21 17.25l-5.877-5.877M11.42 15.17l-4.25-4.25a2.652 2.652 0 0 1 0-3.749l5.25-5.25a2.652 2.652 0 0 1 3.749 0l4.25 4.25M11.42 15.17 11.42 15.17Z" />
        </svg>
        <span class="text-xl font-bold">TUHS Antibiotic Steward</span>
      </div>
      <div class="flex-none">
        <span class="badge badge-primary">FastAPI + Alpine.js</span>
      </div>
    </header>

    <div class="card bg-base-100 shadow-xl">
      <div class="card-body">
        <div class="flex gap-4 flex-col lg:flex-row">
          <!-- Form Section -->
          <div class="lg:w-96 flex flex-col gap-3 overflow-y-auto max-h-[80vh] pr-0 lg:pr-4 lg:border-r">
            <div class="join join-vertical w-full">
              
              <!-- Demographics -->
              <div class="collapse collapse-arrow join-item border-base-300 border">
                <input type="radio" name="form-accordion" checked="checked" />
                <div class="collapse-title text-lg font-medium">Demographics</div>
                <div class="collapse-content">
                  <section class="space-y-3">
                    <div class="grid grid-cols-2 gap-2">
                      <label class="form-control">
                        <span class="label-text">Age</span>
                        <input x-model="age" type="number" class="input input-bordered input-sm" placeholder="67">
                      </label>
                      <label class="form-control">
                        <span class="label-text">Gender</span>
                        <select x-model="gender" class="select select-bordered select-sm">
                          <option value="">Select...</option>
                          <option value="male">Male</option>
                          <option value="female">Female</option>
                        </select>
                      </label>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                      <label class="form-control">
                        <span class="label-text">Weight (kg)</span>
                        <input x-model="weight_kg" type="number" class="input input-bordered input-sm" placeholder="74">
                      </label>
                      <label class="form-control">
                        <span class="label-text">Estimated GFR</span>
                        <input x-model="gfr" type="number" class="input input-bordered input-sm" placeholder="60">
                      </label>
                    </div>
                  </section>
                </div>
              </div>

              <!-- Clinical Details -->
              <div class="collapse collapse-arrow join-item border-base-300 border">
                <input type="radio" name="form-accordion" />
                <div class="collapse-title text-lg font-medium">Clinical Details</div>
                <div class="collapse-content">
                  <section class="space-y-3">
                    <label class="form-control">
                      <span class="label-text">Level of Care</span>
                      <div class="flex gap-2">
                        <label class="label cursor-pointer gap-2 flex-1 bg-base-200 rounded px-2 py-1">
                          <input x-model="location" type="radio" value="Ward" class="radio radio-sm">
                          <span>Ward</span>
                        </label>
                        <label class="label cursor-pointer gap-2 flex-1 bg-base-200 rounded px-2 py-1">
                          <input x-model="location" type="radio" value="ICU" class="radio radio-sm">
                          <span>ICU</span>
                        </label>
                        <label class="label cursor-pointer gap-2 flex-1 bg-base-200 rounded px-2 py-1">
                          <input x-model="location" type="radio" value="ED" class="radio radio-sm">
                          <span>ED</span>
                        </label>
                      </div>
                    </label>

                    <label class="form-control">
                      <span class="label-text">Suspected Source</span>
                      <select x-model="infection_type" class="select select-bordered select-sm">
                        <option value="">Select...</option>
                        <option value="pneumonia">Pneumonia</option>
                        <option value="cystitis">Afebrile/Non-Complicated Cystitis</option>
                        <option value="pyelonephritis">Pyelonephritis/Complicated UTI</option>
                        <option value="skin_soft_tissue">Skin/Soft Tissue</option>
                        <option value="intra_abdominal">Intra-abdominal</option>
                        <option value="bacteremia">Bacteremia</option>
                        <option value="meningitis">Meningitis</option>
                        <option value="bone_joint">Bone/Joint</option>
                        <option value="endocarditis">Endocarditis</option>
                        <option value="other">Other</option>
                      </select>
                    </label>

                    <!-- Show text input when "Other" is selected -->
                    <label x-show="infection_type === 'other'" x-transition class="form-control">
                      <span class="label-text">Specify Other Source</span>
                      <input x-model="otherInfectionSource" type="text" class="input input-bordered input-sm" placeholder="e.g., Peritonitis, Osteomyelitis">
                    </label>

                    <div class="form-control">
                      <span class="label-text mb-1">Allergies</span>
                      <div class="flex flex-wrap gap-2">
                        <template x-for="allergy in allergyOptions" :key="allergy">
                          <label class="badge badge-outline gap-1 px-3 py-2 cursor-pointer">
                            <input type="checkbox" :value="allergy" x-model="allergies" class="checkbox checkbox-xs">
                            <span x-text="allergy"></span>
                          </label>
                        </template>
                      </div>
                      <textarea x-model="allergiesNotes" class="textarea textarea-bordered textarea-sm mt-2" rows="2" placeholder="Add other allergies and reactions"></textarea>
                    </div>

                    <label class="form-control">
                      <span class="label-text">Culture Status</span>
                      <select x-model="cultureStatus" class="select select-bordered select-sm">
                        <option value="Pending">Pending</option>
                        <option value="Positive">Positive</option>
                        <option value="Negative">Negative</option>
                        <option value="Not collected">Not collected</option>
                      </select>
                    </label>

                    <label class="form-control">
                      <span class="label-text">Culture Details</span>
                      <textarea x-model="cultureDetails" class="textarea textarea-bordered textarea-sm" rows="2" placeholder="Blood: MRSA, vanc MIC 1"></textarea>
                    </label>

                    <div class="form-control">
                      <span class="label-text mb-1">Prior Resistance</span>
                      <div class="flex flex-wrap gap-2">
                        <template x-for="resistance in resistanceOptions" :key="resistance">
                          <label class="badge badge-outline gap-1 px-3 py-2 cursor-pointer">
                            <input type="checkbox" :value="resistance" x-model="priorResistance" class="checkbox checkbox-xs">
                            <span x-text="resistance"></span>
                          </label>
                        </template>
                      </div>
                      <textarea x-model="resistanceNotes" class="textarea textarea-bordered textarea-sm mt-2" rows="2" placeholder="Add other resistance patterns"></textarea>
                    </div>
                  </section>
                </div>
              </div>

              <!-- Risk Factors -->
              <div class="collapse collapse-arrow join-item border-base-300 border">
                <input type="radio" name="form-accordion" />
                <div class="collapse-title text-lg font-medium">Risk Factors</div>
                <div class="collapse-content">
                  <section class="space-y-3">
                    <div class="form-control">
                      <span class="label-text mb-1">Source Risk Factors</span>
                      <div class="flex flex-wrap gap-2">
                        <template x-for="risk in sourceRiskOptions" :key="risk">
                          <label class="badge badge-outline gap-1 px-3 py-2 cursor-pointer">
                            <input type="checkbox" :value="risk" x-model="sourceRisks" class="checkbox checkbox-xs">
                            <span x-text="risk"></span>
                          </label>
                        </template>
                      </div>
                      <textarea x-model="sourceRiskNotes" class="textarea textarea-bordered textarea-sm mt-2" rows="2" placeholder="Add other source risk factors"></textarea>
                    </div>

                    <div class="form-control">
                      <span class="label-text mb-1">Infection-Specific Risks</span>
                      <div class="flex flex-wrap gap-2">
                        <template x-for="risk in infRiskOptions" :key="risk">
                          <label class="badge badge-outline gap-1 px-3 py-2 cursor-pointer">
                            <input type="checkbox" :value="risk" x-model="infRisks" class="checkbox checkbox-xs">
                            <span x-text="risk"></span>
                          </label>
                        </template>
                      </div>
                      <textarea x-model="infRiskNotes" class="textarea textarea-bordered textarea-sm mt-2" rows="2" placeholder="Add other infection-specific risks"></textarea>
                    </div>
                  </section>
                </div>
              </div>

              <!-- Current Therapy -->
              <div class="collapse collapse-arrow join-item border-base-300 border">
                <input type="radio" name="form-accordion" />
                <div class="collapse-title text-lg font-medium">Current Therapy</div>
                <div class="collapse-content">
                  <section class="space-y-3">
                    <div class="grid grid-cols-2 gap-2">
                      <label class="form-control">
                        <span class="label-text">Outpatient Antibiotics</span>
                        <input x-model="currentOutptAbx" class="input input-bordered input-sm" placeholder="Azithromycin">
                      </label>
                      <label class="form-control">
                        <span class="label-text">Inpatient Antibiotics</span>
                        <input x-model="currentInpAbx" class="input input-bordered input-sm" placeholder="Vancomycin">
                      </label>
                    </div>
                  </section>
                </div>
              </div>

            </div>

            <!-- Submit Buttons -->
            <div class="flex gap-2 mt-auto pt-4">
              <button @click="submitForm" :disabled="loading" class="btn btn-primary flex-1">
                <span x-show="!loading">Generate Recommendation</span>
                <span x-show="loading" class="loading loading-spinner"></span>
                <span x-show="loading">Processing...</span>
              </button>
              <button @click="resetForm" class="btn btn-ghost" type="button">New Entry</button>
            </div>
          </div>

          <!-- Results Section -->
          <div class="flex-1 overflow-y-auto max-h-[80vh]">
            <div id="results" x-show="result" x-transition>
              <!-- Stats -->
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="stat bg-base-200 rounded-lg">
                  <div class="stat-title">Category</div>
                  <div class="stat-value text-primary text-2xl" x-text="result?.category || 'Unknown'"></div>
                </div>
                <div class="stat bg-base-200 rounded-lg">
                  <div class="stat-title">TUHS Confidence</div>
                  <div class="stat-value text-secondary text-2xl" x-text="Math.round((result?.tuhs_confidence || 0) * 100) + '%'"></div>
                </div>
                <div class="stat bg-base-200 rounded-lg">
                  <div class="stat-title">Final Confidence</div>
                  <div class="stat-value text-accent text-2xl" x-text="Math.round((result?.final_confidence || 0) * 100) + '%'"></div>
                </div>
              </div>

              <!-- Recommendation -->
              <div class="card bg-base-200 mb-4">
                <div class="card-body">
                  <h2 class="card-title">TUHS Antibiotic Recommendation</h2>
                  <div class="clinical-response" x-html="formatRecommendation(result?.tuhs_recommendation)"></div>
                  
                  <!-- Search Evidence Button -->
                  <div class="card-actions justify-end mt-4">
                    <button 
                      @click="searchEvidence()" 
                      :disabled="searchingEvidence"
                      class="btn btn-primary btn-sm gap-2">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                      </svg>
                      <span x-show="!searchingEvidence">Search Evidence (IDSA/PubMed)</span>
                      <span x-show="searchingEvidence" class="loading loading-spinner loading-sm"></span>
                      <span x-show="searchingEvidence">Searching...</span>
                    </button>
                  </div>
                </div>
              </div>

              <!-- Evidence Search Results -->
              <div x-show="evidenceResults" x-transition class="card bg-base-200 mb-4">
                <div class="card-body">
                  <h3 class="card-title text-lg flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-info">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0 0 18 18a8.967 8.967 0 0 0-6 2.292m0-14.25v14.25" />
                    </svg>
                    Evidence Search Results
                  </h3>
                  
                  <!-- Reputable Sources (IDSA, CDC, WHO) -->
                  <div x-show="evidenceResults?.reputable_sources?.length > 0" class="mb-4">
                    <h4 class="font-semibold text-success mb-2">Reputable Sources (IDSA, CDC, WHO, UpToDate)</h4>
                    <div class="space-y-2">
                      <template x-for="source in evidenceResults?.reputable_sources" :key="source.url">
                        <div class="p-3 bg-base-100 rounded-lg">
                          <div class="flex items-start gap-2">
                            <span class="badge badge-success badge-sm mt-1" x-text="source.source"></span>
                            <div class="flex-1">
                              <p class="font-semibold text-sm" x-text="source.title"></p>
                              <p class="text-xs opacity-70 mt-1" x-text="source.finding"></p>
                              <a :href="source.url" target="_blank" class="text-xs text-primary hover:underline mt-1 inline-block">
                                View Source →
                              </a>
                            </div>
                          </div>
                        </div>
                      </template>
                    </div>
                  </div>
                  
                  <!-- Broader Sources (PubMed, etc.) -->
                  <div x-show="evidenceResults?.broader_sources?.length > 0">
                    <h4 class="font-semibold text-info mb-2">Additional Sources (PubMed, Journals)</h4>
                    <div class="space-y-2">
                      <template x-for="source in evidenceResults?.broader_sources" :key="source.url">
                        <div class="p-3 bg-base-100 rounded-lg">
                          <div class="flex items-start gap-2">
                            <span class="badge badge-info badge-sm mt-1" x-text="source.source"></span>
                            <div class="flex-1">
                              <p class="font-semibold text-sm" x-text="source.title"></p>
                              <p class="text-xs opacity-70 mt-1" x-text="source.finding"></p>
                              <a :href="source.url" target="_blank" class="text-xs text-primary hover:underline mt-1 inline-block">
                                View Source →
                              </a>
                            </div>
                          </div>
                        </div>
                      </template>
                    </div>
                  </div>
                  
                  <!-- Updated Confidence -->
                  <div x-show="evidenceResults?.final_confidence" class="alert alert-info mt-4">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span>
                      Updated Confidence: <strong x-text="Math.round((evidenceResults?.final_confidence || 0) * 100) + '%'"></strong>
                      (Evidence <span x-text="evidenceResults?.final_confidence > result?.tuhs_confidence ? 'confirms' : 'reviewed'"></span> TUHS recommendation)
                    </span>
                  </div>
                </div>
              </div>

              <!-- Sources (Original - shown if search was automatic) -->
              <div x-show="result?.reputable_sources?.length > 0 && !evidenceResults" class="card bg-base-200">
                <div class="card-body">
                  <h3 class="card-title text-lg">Sources Consulted (<span x-text="result?.reputable_sources?.length || 0"></span>)</h3>
                  <ul class="list-disc list-inside space-y-1">
                    <template x-for="source in result?.reputable_sources" :key="source.source">
                      <li>
                        <strong x-text="source.source"></strong>: <span x-text="source.title"></span>
                      </li>
                    </template>
                  </ul>
                </div>
              </div>
            </div>

            <!-- Error Display -->
            <div x-show="error" x-transition class="alert alert-error">
              <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <div>
                <h3 class="font-bold">Error!</h3>
                <div class="text-xs" x-text="error"></div>
              </div>
            </div>

            <!-- Placeholder -->
            <div x-show="!result && !error && !loading" class="text-center opacity-50 py-20">
              <p class="text-lg">Enter patient data and click Generate</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    function abxForm() {
      return {
        // Form data
        age: '',
        gender: '',
        weight_kg: '',
        gfr: '',
        location: 'Ward',
        infection_type: '',
        otherInfectionSource: '',
        allergies: [],
        allergiesNotes: '',
        cultureStatus: 'Pending',
        cultureDetails: '',
        priorResistance: [],
        resistanceNotes: '',
        sourceRisks: [],
        sourceRiskNotes: '',
        infRisks: [],
        infRiskNotes: '',
        currentOutptAbx: '',
        currentInpAbx: '',

        // Options
        allergyOptions: [
          'Penicillin (anaphylaxis)',
          'Penicillin (rash)',
          'Cephalosporins',
          'Sulfa',
          'Fluoroquinolones',
          'Carbapenems'
        ],
        resistanceOptions: [
          'MRSA colonization',
          'ESBL Enterobacterales',
          'CRE',
          'VRE',
          'Pseudomonas resistant',
          'C. auris'
        ],
        sourceRiskOptions: [
          'Recent surgery',
          'Indwelling catheter',
          'Prosthetic hardware',
          'LTC residence',
          'Recent hospitalization'
        ],
        infRiskOptions: [
          'Septic shock',
          'Neutropenia',
          'Pregnancy',
          'Renal replacement therapy',
          'Solid organ transplant',
          'Active chemotherapy',
          'Chronic immunosuppression',
          'Immunocompromised state'
        ],

        // State
        result: null,
        error: null,
        loading: false,
        searchingEvidence: false,
        evidenceResults: null,

        // Methods
        async submitForm() {
          this.loading = true;
          this.error = null;
          this.searchingEvidence = false;
          this.evidenceResults = null;

          try {
            // Prepare data
            const formData = {
              age: this.age,
              gender: this.gender,
              weight_kg: this.weight_kg,
              gfr: this.gfr,
              location: this.location,
              infection_type: this.infection_type === 'other' && this.otherInfectionSource 
                ? `other: ${this.otherInfectionSource}` 
                : this.infection_type,
              allergies: [...this.allergies, this.allergiesNotes].filter(Boolean).join('; '),
              culture_results: `${this.cultureStatus}: ${this.cultureDetails || 'No details'}`,
              prior_resistance: [...this.priorResistance, this.resistanceNotes].filter(Boolean).join('; '),
              source_risk: [...this.sourceRisks, this.sourceRiskNotes].filter(Boolean).join('; '),
              inf_risks: [...this.infRisks, this.infRiskNotes].filter(Boolean).join('; '),
              current_outpt_abx: this.currentOutptAbx || 'none',
              current_inp_abx: this.currentInpAbx || 'none'
            };

            console.log('Sending data:', formData);

            // Make API call
            const response = await fetch('/api/recommendation', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(formData)
            });

            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            this.result = await response.json();
            console.log('Received result:', this.result);

          } catch (err) {
            console.error('Error:', err);
            this.error = err.message;
          } finally {
            this.loading = false;
          }
        },

        resetForm() {
          this.age = '';
          this.gender = '';
          this.weight_kg = '';
          this.gfr = '';
          this.location = 'Ward';
          this.infection_type = '';
          this.otherInfectionSource = '';
          this.allergies = [];
          this.allergiesNotes = '';
          this.cultureStatus = 'Pending';
          this.cultureDetails = '';
          this.priorResistance = [];
          this.resistanceNotes = '';
          this.sourceRisks = [];
          this.sourceRiskNotes = '';
          this.infRisks = [];
          this.infRiskNotes = '';
          this.currentOutptAbx = '';
          this.currentInpAbx = '';
          this.result = null;
          this.error = null;
        },

        async searchEvidence() {
          if (!this.result) return;
          
          this.searchingEvidence = true;
          this.evidenceResults = null;
          
          try {
            // Build search query from current case
            const searchQuery = `${this.infection_type} treatment ${this.age}yo ${this.allergies.join(' ')}`;
            
            // Call evidence search endpoint
            const response = await fetch('/api/search-evidence', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                query: searchQuery,
                infection_type: this.infection_type,
                tuhs_recommendation: this.result.tuhs_recommendation,
                tuhs_confidence: this.result.tuhs_confidence
              })
            });
            
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            this.evidenceResults = await response.json();
            console.log('Evidence search results:', this.evidenceResults);
            
          } catch (err) {
            console.error('Evidence search error:', err);
            this.error = `Evidence search failed: ${err.message}`;
          } finally {
            this.searchingEvidence = false;
          }
        },

        formatRecommendation(text) {
          if (!text) return '<p>No recommendation available</p>';
          return marked.parse(text);
        }
      }
    }

    // Initialize marked
    marked.setOptions({
      breaks: true,
      gfm: true,
      smartypants: false  // Disable smart quotes and other automatic formatting
    });
  </script>
</body>
</html>
